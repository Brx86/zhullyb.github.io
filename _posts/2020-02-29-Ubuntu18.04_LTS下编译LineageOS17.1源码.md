---
layout:     post
title:      Ubuntu18.04_LTS下编译LineageOS 17.1源码
date:       2020-02-29
author:     竹林里有冰
categories: Shell
tags:
    - Linux
    - 技术文档
    - 教程
    -  ROM编译
---

* content
{:toc}

## 0.1 介绍
在 Ubuntu 18.04 下编译 LineageOS/CM 等 AOSP 源码可能会踩到很多坑。下面就跟我一起来配置避免入坑吧。Ubuntu 18.04 LTS 请选择 64 位的。
### 设备最低要求
CPU: Core i3 530 及以上的 CPU（推荐 Intel Core i7 6 代以上或 AMD Ryzen 系列 CPU)

RAM: 12GB 及以上的 RAM（推荐 16GB 及以上)

HDD: HDD 210GB 及以上剩余存储空间（推荐 SSD 256GB 及以上）

当然 CPU 差点没事，只不过是浪费时间与电费而已。源码所在目录最低剩余空间不要小于 200GB。

### 操作系统
Ubuntu 18.04 LTS 64bit
## 0.2 安装依赖
这一步安装之前你可以先给Ubuntu换源，具体的教程可以百度，我个人推荐清华的源。
```
sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libwxgtk3.0-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev imagemagick libbz2-dev libssl-dev lzma ncftp bash-completion m4 openjdk-8-jdk python clang jq
```
## 0.3安装repo源码同步工具
```
mkdir ~/.bin
PATH=~/.bin:$PATH
curl https://raw.githubusercontent.com/MoKee/git-repo/stable/repo > ~/.bin/repo
chmod a+x ~/.bin/repo
```
 ## 0.4 设置git
1. 设置 git 用户名和邮箱
示例如下：
```git config --global user.email "you@example.com"```
```git config --global user.name "Your Name"```

双引号中的 “you@example.com” 填写您的 github 所使用的邮箱。注意格式，不要把双引号去掉。
双引号中的 “Your Name” 填写您的 github 用户名，不要把双引号去掉。
2. 生成 ssh 并添加到 github：

您可以参考官方的[文档](https://help.github.com/articles/connecting-to-github-with-ssh/)

如果您不将 ssh 添加到 github 的话，您可能会遭遇下载受限，从而导致接下来的同步源码失败。
## 0.5 下载源码
注：千万不要使用中文路径！千万不要包含空格或一些特殊字符！不要将使用 Windows 的坏习惯带入到 Linux 中来！
1. 新建源码目录：
```
mkdir lineage-17.1
cd lineage-17.1
```
2. 初始化源码
```
repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/lineageOS/LineageOS/android.git -b lineage-17.1
```
3. 使用清华源同步LineageOS源码
打开.repo/manifest.xml， \

把
```
  <remote  name="github"
           fetch=".."
           review="review.lineageos.org" />
```
改成
```
  <remote  name="github"
           fetch="https://github.com/" />

  <remote  name="lineage"
           fetch="https://mirrors.tuna.tsinghua.edu.cn/git/lineageOS/"
           review="review.lineageos.org" />
```
将
```
  <remote  name="aosp"
           fetch="https://android.googlesource.com"
```
改成
```
  <remote  name="aosp"
           fetch="https://aosp.tuna.tsinghua.edu.cn"
```
将
```
  <default revision="..."
           remote="github"
```
改成
```
  <default revision="..."
           remote="lineage"
```
4. 正式同步源码
```
repo sync  --force-sync --current-branch --no-tags --no-clone-bundle --optimized-fetch --prune -j$(nproc --all)
```
源码大概要15G大小左右，做好心理准备，要下很久
当同步源码接近完毕后，会提示 Syncing work tree。
## 0.6 同步设备源码
这里我们直接寻找自己设备的源码即可
使用git clone命令来下载源码
```
git clone https://github.com/xxx/xxx.git <对应路径>
```
比如我的小米8就是
```
git clone https://github.com/Bamice/android_device_xiaomi_dipper.git -b ten --depth=1 -j4 device/xiaomi/dipper
git clone https://github.com/Bamice/android_device_xiaomi_sdm845-common.git -b ten --depth=1 -j4 device/xiaomi/sdm845-common
git clone https://github.com/LineageOS/android_kernel_xiaomi_sdm845.git --depth=1 -j4 kernel/xiaomi/sdm845
git clone https://github.com/Bamice/proprietary_vendor_xiaomi-dipper.git -b ten --depth=1 -j4 vendor/xiaomi
```
Ps:  \
```--depth=1```表示只保留一次提交记录，减少下载量  \
```-j4```表示使用4线程```clone```对应仓库 \
```-b ten```表示clone的是```ten```分支
## 处理相关配置文件
将终端语言调为英语防止报错
```
echo "export LANG=C" >> ~/.bashrc
source ~/.bashrc
```
# 编译
## 1.0 bring up
就讲讲我那套小米8的源码吧
打开```device/xiaomi/dipper```
修改```AndroidProducts.mk```里的```aosp_dipper.mk```为```lineage_dipper.mk```
重命名```aosp_dipper.mk```为```lineage_dipper.mk```
修改```lineage_dipper.mk```中的```vendor/aosp/config/common_full_phone.mk```为```vendor/lineage/config/common_full_phone.mk```，```aosp_dipper```为```lineage_dipper```
## 1.1 开始编译
1. 设置编译变量
```
. build/envsetup.sh
```
2. 编译
```
croot
brunch lineage_dipper-userdebug 2>&1 | tee build.log
```
此时，编译日志会自动存在build.log下，以便后续查看
## 1.2 编译完成
编译完成后，会在 源码目录```/out/target/product/您的机型``` 文件夹生成对应的刷机包、镜像和一些编译出来的文件。

假如在编译过程中遇到报错，尝试 Google 对应的报错内容，不建议使用国内搜索引擎。
## 1.3 Make Clean
编译完成后，可执行清理步骤：
```
make clean
```
